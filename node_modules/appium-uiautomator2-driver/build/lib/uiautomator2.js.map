{"version":3,"file":"uiautomator2.js","names":["REQD_PARAMS","SERVER_LAUNCH_TIMEOUT","SERVER_INSTALL_RETRIES","SERVICES_LAUNCH_TIMEOUT","SERVER_PACKAGE_ID","SERVER_TEST_PACKAGE_ID","INSTRUMENTATION_TARGET","instrumentationLogger","logger","getLogger","UIA2Proxy","JWProxy","proxyCommand","url","method","body","didInstrumentationExit","errors","InvalidContextError","UiAutomator2Server","constructor","log","opts","req","util","hasValue","Error","disableSuppressAccessibilityService","proxyOpts","server","host","port","systemPort","keepAlive","readTimeout","timeout","jwproxy","proxyReqRes","bind","command","installServerApk","installTimeout","tmpRoot","tempDir","openDir","packageInfosMapper","appPath","appId","helpers","isWriteable","info","dstPath","path","resolve","basename","fs","copyFile","packagesInfo","B","all","map","apkPath","testApkPath","shouldUninstallServerPackages","shouldInstallServerPackages","isAppInstalled","adb","checkApkCert","signApp","appState","getApplicationInstallState","debug","APP_INSTALL_STATE","OLDER_VERSION_INSTALLED","NEWER_VERSION_INSTALLED","includes","NOT_INSTALLED","uninstallApk","err","warn","message","install","noIncremental","replace","timeoutCapName","rimraf","verifyServicesAvailability","isPmServiceAvailable","pmOutput","pmError","waitForCondition","shell","e","waitMs","intervalMs","error","line","split","startSession","caps","cleanupAutomationLeftovers","skipServerInstallation","serverVersion","uiautomator2ServerLaunchTimeout","timer","timing","Timer","start","retries","maxRetries","delayBetweenRetries","startInstrumentationProcess","errorAndThrow","delay","getDuration","asMilliSeconds","toFixed","capabilities","firstMatch","alwaysMatch","cmd","disableWindowAnimation","push","_","isBoolean","instrumentationProcess","createSubProcess","on","stdout","stderr","output","trim","code","deleteSession","strictCleanup","value","axios","data","activeSessionIds","id","filter","Boolean","length","JSON","stringify","pluralize","delete","forceStop","ignore","killProcessesByName"],"sources":["../../lib/uiautomator2.js"],"sourcesContent":["import _ from 'lodash';\nimport { JWProxy, errors } from 'appium/driver';\nimport { waitForCondition } from 'asyncbox';\nimport {\n  SERVER_APK_PATH as apkPath,\n  TEST_APK_PATH as testApkPath,\n  version as serverVersion\n} from 'appium-uiautomator2-server';\nimport {\n  util, logger, tempDir, fs, timing\n} from 'appium/support';\nimport B from 'bluebird';\nimport helpers from './helpers';\nimport axios from 'axios';\nimport path from 'path';\n\nconst REQD_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'disableWindowAnimation'];\nconst SERVER_LAUNCH_TIMEOUT = 30000;\nconst SERVER_INSTALL_RETRIES = 20;\nconst SERVICES_LAUNCH_TIMEOUT = 30000;\nconst SERVER_PACKAGE_ID = 'io.appium.uiautomator2.server';\nconst SERVER_TEST_PACKAGE_ID = `${SERVER_PACKAGE_ID}.test`;\nconst INSTRUMENTATION_TARGET = `${SERVER_TEST_PACKAGE_ID}/androidx.test.runner.AndroidJUnitRunner`;\nconst instrumentationLogger = logger.getLogger('Instrumentation');\n\nclass UIA2Proxy extends JWProxy {\n  async proxyCommand (url, method, body = null) {\n    if (this.didInstrumentationExit) {\n      throw new errors.InvalidContextError(\n        `'${method} ${url}' cannot be proxied to UiAutomator2 server because ` +\n        'the instrumentation process is not running (probably crashed). ' +\n        'Check the server log and/or the logcat output for more details');\n    }\n    return await super.proxyCommand(url, method, body);\n  }\n}\n\nclass UiAutomator2Server {\n  constructor (log, opts = {}) {\n    for (let req of REQD_PARAMS) {\n      if (!opts || !util.hasValue(opts[req])) {\n        throw new Error(`Option '${req}' is required!`);\n      }\n      this[req] = opts[req];\n    }\n    this.log = log;\n    this.disableSuppressAccessibilityService = opts.disableSuppressAccessibilityService;\n    const proxyOpts = {\n      log,\n      server: this.host,\n      port: this.systemPort,\n      keepAlive: true,\n    };\n    if (opts.readTimeout && opts.readTimeout > 0) {\n      proxyOpts.timeout = opts.readTimeout;\n    }\n    this.jwproxy = new UIA2Proxy(proxyOpts);\n    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);\n    this.proxyCommand = this.jwproxy.command.bind(this.jwproxy);\n    this.jwproxy.didInstrumentationExit = false;\n  }\n\n  /**\n   * Installs the apks on to the device or emulator.\n   *\n   * @param {number} installTimeout - Installation timeout\n   */\n  async installServerApk (installTimeout = SERVER_INSTALL_RETRIES * 1000) {\n    const tmpRoot = await tempDir.openDir();\n    const packageInfosMapper = async ({appPath, appId}) => {\n      if (await helpers.isWriteable(appPath)) {\n        return { appPath, appId };\n      }\n\n      this.log.info(`Server package at '${appPath}' is not writeable. ` +\n        `Will copy it into the temporary location at '${tmpRoot}' as a workaround. ` +\n        `Consider making this file writeable manually in order to improve the performance of session startup.`);\n      const dstPath = path.resolve(tmpRoot, path.basename(appPath));\n      await fs.copyFile(appPath, dstPath);\n      return {\n        appPath: dstPath,\n        appId,\n      };\n    };\n\n    try {\n      const packagesInfo = await B.all(B.map([\n        {\n          appPath: apkPath,\n          appId: SERVER_PACKAGE_ID,\n        }, {\n          appPath: testApkPath,\n          appId: SERVER_TEST_PACKAGE_ID,\n        },\n      ], packageInfosMapper));\n\n      let shouldUninstallServerPackages = false;\n      let shouldInstallServerPackages = false;\n      for (const {appId, appPath} of packagesInfo) {\n        if (appId === SERVER_TEST_PACKAGE_ID) {\n          const isAppInstalled = await this.adb.isAppInstalled(appId);\n\n          // There is no point in getting the state for test server,\n          // since it does not contain version info\n          if (!await this.adb.checkApkCert(appPath, appId)) {\n            await helpers.signApp(this.adb, appPath);\n            shouldUninstallServerPackages = shouldUninstallServerPackages || isAppInstalled;\n            shouldInstallServerPackages = true;\n          }\n\n          if (!isAppInstalled) {\n            shouldInstallServerPackages = true;\n          }\n          continue;\n        }\n\n        const appState = await this.adb.getApplicationInstallState(appPath, appId);\n        this.log.debug(`${appId} installation state: ${appState}`);\n        if (await this.adb.checkApkCert(appPath, appId)) {\n          shouldUninstallServerPackages = shouldUninstallServerPackages || [\n            this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED,\n            this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED,\n          ].includes(appState);\n        } else {\n          await helpers.signApp(this.adb, appPath);\n          shouldUninstallServerPackages = shouldUninstallServerPackages || ![\n            this.adb.APP_INSTALL_STATE.NOT_INSTALLED,\n          ].includes(appState);\n        }\n        shouldInstallServerPackages = shouldInstallServerPackages || shouldUninstallServerPackages || [\n          this.adb.APP_INSTALL_STATE.NOT_INSTALLED,\n        ].includes(appState);\n      }\n      this.log.info(`Server packages are ${shouldInstallServerPackages ? '' : 'not '}going to be (re)installed`);\n      if (shouldInstallServerPackages && shouldUninstallServerPackages) {\n        this.log.info('Full packages reinstall is going to be performed');\n      }\n      for (const {appId, appPath} of packagesInfo) {\n        if (shouldUninstallServerPackages) {\n          try {\n            await this.adb.uninstallApk(appId);\n          } catch (err) {\n            this.log.warn(`Error uninstalling '${appId}': ${err.message}`);\n          }\n        }\n        if (shouldInstallServerPackages) {\n          await this.adb.install(appPath, {\n            noIncremental: true,\n            replace: true,\n            timeout: installTimeout,\n            timeoutCapName: 'uiautomator2ServerInstallTimeout'\n          });\n        }\n      }\n    } finally {\n      await fs.rimraf(tmpRoot);\n    }\n\n    await this.verifyServicesAvailability();\n  }\n\n  async verifyServicesAvailability () {\n    this.log.debug(`Waiting up to ${SERVICES_LAUNCH_TIMEOUT}ms for services to be available`);\n    let isPmServiceAvailable = false;\n    let pmOutput = '';\n    let pmError = null;\n    try {\n      await waitForCondition(async () => {\n        if (!isPmServiceAvailable) {\n          pmError = null;\n          pmOutput = '';\n          try {\n            pmOutput = await this.adb.shell(['pm', 'list', 'instrumentation']);\n          } catch (e) {\n            pmError = e;\n          }\n          if (pmOutput.includes('Could not access the Package Manager')) {\n            pmError = new Error(`Problem running Package Manager: ${pmOutput}`);\n            pmOutput = ''; // remove output, so it is not printed below\n          } else if (pmOutput.includes(INSTRUMENTATION_TARGET)) {\n            pmOutput = ''; // remove output, so it is not printed below\n            this.log.debug(`Instrumentation target '${INSTRUMENTATION_TARGET}' is available`);\n            // eslint-disable-next-line require-atomic-updates\n            isPmServiceAvailable = true;\n          } else if (!pmError) {\n            pmError = new Error('The instrumentation target is not listed by Package Manager');\n          }\n        }\n        return isPmServiceAvailable;\n      }, {\n        waitMs: SERVICES_LAUNCH_TIMEOUT,\n        intervalMs: 1000,\n      });\n    } catch (err) {\n      this.log.error(`Unable to find instrumentation target '${INSTRUMENTATION_TARGET}': ${(pmError || {}).message}`);\n      if (pmOutput) {\n        this.log.debug('Available targets:');\n        for (const line of pmOutput.split('\\n')) {\n          this.log.debug(`    ${line.replace('instrumentation:', '')}`);\n        }\n      }\n    }\n  }\n\n  async startSession (caps) {\n    await this.cleanupAutomationLeftovers();\n    if (caps.skipServerInstallation) {\n      this.log.info(`'skipServerInstallation' is set. Attempting to use UIAutomator2 server from the device`);\n    } else {\n      this.log.info(`Starting UIAutomator2 server ${serverVersion}`);\n      this.log.info(`Using UIAutomator2 server from '${apkPath}' and test from '${testApkPath}'`);\n    }\n\n    const timeout = caps.uiautomator2ServerLaunchTimeout || SERVER_LAUNCH_TIMEOUT;\n    const timer = new timing.Timer().start();\n    let retries = 0;\n    const maxRetries = 2;\n    const delayBetweenRetries = 3000;\n    while (retries < maxRetries) {\n      this.log.info(`Waiting up to ${timeout}ms for UiAutomator2 to be online...`);\n      this.jwproxy.didInstrumentationExit = false;\n      await this.startInstrumentationProcess();\n      if (!this.jwproxy.didInstrumentationExit) {\n        try {\n          await waitForCondition(async () => {\n            try {\n              await this.jwproxy.command('/status', 'GET');\n              return true;\n            } catch (err) {\n              // short circuit to retry or fail fast\n              return this.jwproxy.didInstrumentationExit;\n            }\n          }, {\n            waitMs: timeout,\n            intervalMs: 1000,\n          });\n        } catch (err) {\n          this.log.errorAndThrow(`The instrumentation process cannot be initialized within ${timeout}ms timeout. `\n            + 'Make sure the application under test does not crash and investigate the logcat output. '\n            + `You could also try to increase the value of 'uiautomator2ServerLaunchTimeout' capability`);\n        }\n      }\n      if (!this.jwproxy.didInstrumentationExit) {\n        break;\n      }\n\n      retries++;\n      if (retries >= maxRetries) {\n        this.log.errorAndThrow('The instrumentation process cannot be initialized. '\n          + 'Make sure the application under test does not crash and investigate the logcat output.');\n      }\n      this.log.warn(`The instrumentation process has been unexpectedly terminated. `\n        + `Retrying UiAutomator2 startup (#${retries} of ${maxRetries - 1})`);\n      await this.cleanupAutomationLeftovers(true);\n      await B.delay(delayBetweenRetries);\n    }\n\n    this.log.debug(`The initialization of the instrumentation process took `\n      + `${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);\n    await this.jwproxy.command('/session', 'POST', {\n      capabilities: {\n        firstMatch: [caps],\n        alwaysMatch: {},\n      }\n    });\n  }\n\n  async startInstrumentationProcess () {\n    const cmd = ['am', 'instrument', '-w'];\n    if (this.disableWindowAnimation) {\n      cmd.push('--no-window-animation');\n    }\n    if (_.isBoolean(this.disableSuppressAccessibilityService)) {\n      cmd.push('-e', 'DISABLE_SUPPRESS_ACCESSIBILITY_SERVICES', this.disableSuppressAccessibilityService);\n    }\n    // Disable Google analytics to prevent possible fatal exception\n    cmd.push('-e', 'disableAnalytics', true);\n    cmd.push(INSTRUMENTATION_TARGET);\n    const instrumentationProcess = this.adb.createSubProcess(['shell', ...cmd]);\n    instrumentationProcess.on('output', (stdout, stderr) => {\n      const output = _.trim(stdout || stderr);\n      if (output) {\n        instrumentationLogger.debug(output);\n      }\n    });\n    instrumentationProcess.on('exit', (code) => {\n      instrumentationLogger.debug(`The process has exited with code ${code}`);\n      this.jwproxy.didInstrumentationExit = true;\n    });\n    await instrumentationProcess.start(0);\n  }\n\n  async deleteSession () {\n    this.log.debug('Deleting UiAutomator2 server session');\n    // rely on jwproxy's intelligence to know what we're talking about and\n    // delete the current session\n    try {\n      await this.jwproxy.command('/', 'DELETE');\n    } catch (err) {\n      this.log.warn(`Did not get confirmation UiAutomator2 deleteSession worked; ` +\n          `Error was: ${err}`);\n    }\n  }\n\n  async cleanupAutomationLeftovers (strictCleanup = false) {\n    this.log.debug(`Performing ${strictCleanup ? 'strict' : 'shallow'} cleanup of automation leftovers`);\n\n    try {\n      const {value} = (await axios({\n        url: `http://${this.host}:${this.systemPort}/sessions`,\n        timeout: 500,\n      })).data;\n      const activeSessionIds = value.map(({id}) => id).filter(Boolean);\n      if (activeSessionIds.length) {\n        this.log.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);\n        this.log.debug(`Cleaning up ${util.pluralize('obsolete session', activeSessionIds.length, true)}`);\n        await B.all(activeSessionIds\n          .map((id) => axios.delete(`http://${this.host}:${this.systemPort}/session/${id}`))\n        );\n        // Let all sessions to be properly terminated before continuing\n        await B.delay(1000);\n      } else {\n        this.log.debug('No obsolete sessions have been detected');\n      }\n    } catch (e) {\n      this.log.debug(`No obsolete sessions have been detected (${e.message})`);\n    }\n\n    try {\n      await this.adb.forceStop(SERVER_TEST_PACKAGE_ID);\n    } catch (ignore) {}\n    if (!strictCleanup) {\n      return;\n    }\n    // https://github.com/appium/appium/issues/10749\n    try {\n      await this.adb.killProcessesByName('uiautomator');\n    } catch (ignore) {}\n  }\n}\n\nexport { UiAutomator2Server, INSTRUMENTATION_TARGET, SERVER_PACKAGE_ID, SERVER_TEST_PACKAGE_ID };\nexport default UiAutomator2Server;\n"],"mappings":"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"}