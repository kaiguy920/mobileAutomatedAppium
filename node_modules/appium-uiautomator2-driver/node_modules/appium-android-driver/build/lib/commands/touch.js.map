{"version":3,"file":"touch.js","names":["commands","helpers","extensions","getCoordDefault","val","util","hasValue","getSwipeTouchDuration","waitGesture","duration","options","ms","doTouchAction","action","opts","element","x","y","count","tap","touchDown","touchUp","touchMove","B","delay","touchLongClick","log","warn","errorAndThrow","doTouchDrag","gestures","longPress","moveTo","startX","startY","endX","endY","getLocationInView","apiLevel","adb","getApiLevel","Math","max","drag","fixRelease","release","_","last","clone","ref","gesture","reverse","loc","size","getSize","width","height","pick","performGesture","e","isErrorType","errors","NoSuchElementError","debug","getSwipeOptions","touchCount","destElement","locResult","sizeResult","offsetX","abs","offsetY","firstElLocation","performTouch","length","swipeOpts","swipe","actions","map","head","pop","slice","press","shift","wait","fixedGestures","parseTouch","g","multi","touchStateObjects","asyncmap","includes","offset","elementId","pos","touchStateObject","timeOffset","parseInt","prevPos","time","state","isUndefined","androidHelpers","truncateDecimals","touch","performMultiAction","Error","states","doPerformMultiAction","bootstrap","sendAction","Object","assign"],"sources":["../../../lib/commands/touch.js"],"sourcesContent":["import _ from 'lodash';\nimport androidHelpers from '../android-helpers';\nimport B from 'bluebird';\nimport { errors, isErrorType } from 'appium/driver';\nimport { asyncmap } from 'asyncbox';\nimport { util } from 'appium/support';\n\nlet commands = {}, helpers = {}, extensions = {};\n\nfunction getCoordDefault (val) {\n  // going the long way and checking for undefined and null since\n  // we can't be assured `elId` is a string and not an int. Same\n  // thing with destElement below.\n  return util.hasValue(val) ? val : 0.5;\n}\n\nfunction getSwipeTouchDuration (waitGesture) {\n  // the touch action api uses ms, we want seconds\n  // 0.8 is the default time for the operation\n  let duration = 0.8;\n  if (typeof waitGesture.options.ms !== 'undefined' && waitGesture.options.ms) {\n    duration = waitGesture.options.ms / 1000;\n    if (duration === 0) {\n      // set to a very low number, since they wanted it fast\n      // but below 0.1 becomes 0 steps, which causes errors\n      duration = 0.1;\n    }\n  }\n  return duration;\n}\n\ncommands.doTouchAction = async function doTouchAction (action, opts = {}) {\n  const { element, x, y, count, ms, duration } = opts;\n  // parseTouch precalculates absolute element positions\n  // so there is no need to pass `element` to the affected gestures\n  switch (action) {\n    case 'tap':\n      return await this.tap(null, x, y, count);\n    case 'press':\n      return await this.touchDown(null, x, y);\n    case 'release':\n      return await this.touchUp(element, x, y);\n    case 'moveTo':\n      return await this.touchMove(null, x, y);\n    case 'wait':\n      return await B.delay(ms);\n    case 'longPress':\n      return await this.touchLongClick(null, x, y, duration || 1000);\n    case 'cancel':\n      // TODO: clarify behavior of 'cancel' action and fix this\n      this.log.warn('Cancel action currently has no effect');\n      break;\n    default:\n      this.log.errorAndThrow(`unknown action ${action}`);\n  }\n};\n\n// drag is *not* press-move-release, so we need to translate\n// drag works fine for scroll, as well\nhelpers.doTouchDrag = async function doTouchDrag (gestures) {\n  let longPress = gestures[0];\n  let moveTo = gestures[1];\n  let startX = longPress.options.x || 0,\n      startY = longPress.options.y || 0,\n      endX = moveTo.options.x || 0,\n      endY = moveTo.options.y || 0;\n  if (longPress.options.element) {\n    let {x, y} = await this.getLocationInView(longPress.options.element);\n    startX += x || 0;\n    startY += y || 0;\n  }\n  if (moveTo.options.element) {\n    let {x, y} = await this.getLocationInView(moveTo.options.element);\n    endX += x || 0;\n    endY += y || 0;\n  }\n\n  let apiLevel = await this.adb.getApiLevel();\n  // lollipop takes a little longer to get things rolling\n  let duration = apiLevel >= 5 ? 2 : 1;\n  // make sure that if the long press has a duration, we use it.\n  if (longPress.options && longPress.options.duration) {\n    duration = Math.max(longPress.options.duration / 1000, duration);\n  }\n\n  // `drag` will take care of whether there is an element or not at that level\n  return await this.drag(startX, startY, endX, endY, duration, 1, longPress.options.element, moveTo.options.element);\n};\n\n// Release gesture needs element or co-ordinates to release it from that position\n// or else release gesture is performed from center of the screen, so to fix it\n// This method sets co-ordinates/element to release gesture if it has no options set already.\nhelpers.fixRelease = async function fixRelease (gestures) {\n  let release = _.last(gestures);\n  // sometimes there are no options\n  release.options = release.options || {};\n  // nothing to do if release options are already set\n  if (release.options.element || (release.options.x && release.options.y)) {\n    return;\n  }\n  // without coordinates, `release` uses the center of the screen, which,\n  // generally speaking, is not what we want\n  // therefore: loop backwards and use the last command with an element and/or\n  // offset coordinates\n  gestures = _.clone(gestures);\n  let ref = null;\n  for (let gesture of gestures.reverse()) {\n    let opts = gesture.options;\n    if (opts.element || (opts.x && opts.y)) {\n      ref = gesture;\n      break;\n    }\n  }\n  if (ref) {\n    let opts = ref.options;\n    if (opts.element) {\n      let loc = await this.getLocationInView(opts.element);\n      if (opts.x && opts.y) {\n        // this is an offset from the element\n        release.options = {\n          x: loc.x + opts.x,\n          y: loc.y + opts.y\n        };\n      } else {\n        // this is the center of the element\n        let size = await this.getSize(opts.element);\n        release.options = {\n          x: loc.x + size.width / 2,\n          y: loc.y + size.height / 2\n        };\n      }\n    } else {\n      release.options = _.pick(opts, 'x', 'y');\n    }\n  }\n  return release;\n};\n\n// Perform one gesture\nhelpers.performGesture = async function performGesture (gesture) {\n  try {\n    return await this.doTouchAction(gesture.action, gesture.options || {});\n  } catch (e) {\n    // sometime the element is not available when releasing, retry without it\n    if (isErrorType(e, errors.NoSuchElementError) && gesture.action === 'release' &&\n        gesture.options.element) {\n      delete gesture.options.element;\n      this.log.debug(`retrying release without element opts: ${gesture.options}.`);\n      return await this.doTouchAction(gesture.action, gesture.options || {});\n    }\n    throw e;\n  }\n};\n\ncommands.getSwipeOptions = async function getSwipeOptions (gestures, touchCount = 1) {\n  let startX = getCoordDefault(gestures[0].options.x),\n      startY = getCoordDefault(gestures[0].options.y),\n      endX = getCoordDefault(gestures[2].options.x),\n      endY = getCoordDefault(gestures[2].options.y),\n      duration = getSwipeTouchDuration(gestures[1]),\n      element = gestures[0].options.element,\n      destElement = gestures[2].options.element || gestures[0].options.element;\n\n  // there's no destination element handling in bootstrap and since it applies to all platforms, we handle it here\n  if (util.hasValue(destElement)) {\n    let locResult = await this.getLocationInView(destElement);\n    let sizeResult = await this.getSize(destElement);\n    let offsetX = (Math.abs(endX) < 1 && Math.abs(endX) > 0) ? sizeResult.width * endX : endX;\n    let offsetY = (Math.abs(endY) < 1 && Math.abs(endY) > 0) ? sizeResult.height * endY : endY;\n    endX = locResult.x + offsetX;\n    endY = locResult.y + offsetY;\n    // if the target element was provided, the coordinates for the destination need to be relative to it.\n    if (util.hasValue(element)) {\n      let firstElLocation = await this.getLocationInView(element);\n      endX -= firstElLocation.x;\n      endY -= firstElLocation.y;\n    }\n  }\n  // clients are responsible to use these options correctly\n  return {startX, startY, endX, endY, duration, touchCount, element};\n};\n\ncommands.performTouch = async function performTouch (gestures) {\n  // press-wait-moveTo-release is `swipe`, so use native method\n  if (gestures.length === 4 &&\n      gestures[0].action === 'press' &&\n      gestures[1].action === 'wait' &&\n      gestures[2].action === 'moveTo' &&\n      gestures[3].action === 'release') {\n\n    let swipeOpts = await this.getSwipeOptions(gestures);\n    return await this.swipe(swipeOpts.startX, swipeOpts.startY, swipeOpts.endX,\n        swipeOpts.endY, swipeOpts.duration, swipeOpts.touchCount,\n        swipeOpts.element);\n  }\n  let actions = _.map(gestures, 'action');\n\n  if (actions[0] === 'longPress' && actions[1] === 'moveTo' && actions[2] === 'release') {\n    // some things are special\n    return await this.doTouchDrag(gestures);\n  } else {\n    if (actions.length === 2) {\n      // `press` without a wait is too slow and gets interpretted as a `longPress`\n      if (_.head(actions) === 'press' && _.last(actions) === 'release') {\n        actions[0] = 'tap';\n        gestures[0].action = 'tap';\n      }\n\n      // the `longPress` and `tap` methods release on their own\n      if ((_.head(actions) === 'tap' || _.head(actions) === 'longPress') && _.last(actions) === 'release') {\n        gestures.pop();\n        actions.pop();\n      }\n    } else {\n      // longpress followed by anything other than release should become a press and wait\n      if (actions[0] === 'longPress') {\n        actions = ['press', 'wait', ...actions.slice(1)];\n\n        let press = gestures.shift();\n        press.action = 'press';\n        let wait = {\n          action: 'wait',\n          options: {ms: press.options.duration || 1000}\n        };\n        delete press.options.duration;\n        gestures = [press, wait, ...gestures];\n      }\n    }\n\n    let fixedGestures = await this.parseTouch(gestures, false);\n    // fix release action then perform all actions\n    if (actions[actions.length - 1] === 'release') {\n      actions[actions.length - 1] = await this.fixRelease(gestures);\n    }\n    for (let g of fixedGestures) {\n      await this.performGesture(g);\n    }\n  }\n};\n\nhelpers.parseTouch = async function parseTouch (gestures, multi) {\n  // because multi-touch releases at the end by default\n  if (multi && _.last(gestures).action === 'release') {\n    gestures.pop();\n  }\n\n  let touchStateObjects = await asyncmap(gestures, async (gesture) => {\n    let options = gesture.options || {};\n    if (_.includes(['press', 'moveTo', 'tap', 'longPress'], gesture.action)) {\n      options.offset = false;\n      let elementId = gesture.options.element;\n      if (elementId) {\n        let pos = await this.getLocationInView(elementId);\n        if (gesture.options.x || gesture.options.y) {\n          options.x = pos.x + (gesture.options.x || 0);\n          options.y = pos.y + (gesture.options.y || 0);\n        } else {\n          const {width, height} = await this.getSize(elementId);\n          options.x = pos.x + (width / 2);\n          options.y = pos.y + (height / 2);\n        }\n        let touchStateObject = {\n          action: gesture.action,\n          options,\n          timeOffset: 0.005,\n        };\n        return touchStateObject;\n      } else {\n        options.x = (gesture.options.x || 0);\n        options.y = (gesture.options.y || 0);\n\n        let touchStateObject = {\n          action: gesture.action,\n          options,\n          timeOffset: 0.005,\n        };\n        return touchStateObject;\n      }\n    } else {\n      let offset = 0.005;\n      if (gesture.action === 'wait') {\n        options = gesture.options;\n        offset = (parseInt(gesture.options.ms, 10) / 1000);\n      }\n      let touchStateObject = {\n        action: gesture.action,\n        options,\n        timeOffset: offset,\n      };\n      return touchStateObject;\n    }\n  }, false);\n  // we need to change the time (which is now an offset)\n  // and the position (which may be an offset)\n  let prevPos = null,\n      time = 0;\n  for (let state of touchStateObjects) {\n    if (_.isUndefined(state.options.x) && _.isUndefined(state.options.y) && prevPos !== null) {\n      // this happens with wait\n      state.options.x = prevPos.x;\n      state.options.y = prevPos.y;\n    }\n    if (state.options.offset && prevPos) {\n      // the current position is an offset\n      state.options.x += prevPos.x;\n      state.options.y += prevPos.y;\n    }\n    delete state.options.offset;\n    if (!_.isUndefined(state.options.x) && !_.isUndefined(state.options.y)) {\n      prevPos = state.options;\n    }\n\n    if (multi) {\n      let timeOffset = state.timeOffset;\n      time += timeOffset;\n      state.time = androidHelpers.truncateDecimals(time, 3);\n\n      // multi gestures require 'touch' rather than 'options'\n      if (!_.isUndefined(state.options.x) && !_.isUndefined(state.options.y)) {\n        state.touch = {\n          x: state.options.x,\n          y: state.options.y\n        };\n      }\n      delete state.options;\n    }\n    delete state.timeOffset;\n  }\n  return touchStateObjects;\n};\n\n\ncommands.performMultiAction = async function performMultiAction (actions, elementId) {\n  // Android needs at least two actions to be able to perform a multi pointer gesture\n  if (actions.length === 1) {\n    throw new Error('Multi Pointer Gestures need at least two actions. ' +\n        'Use Touch Actions for a single action.');\n  }\n\n  const states = await asyncmap(actions, async (action) => await this.parseTouch(action, true), false);\n\n  return await this.doPerformMultiAction(elementId, states);\n};\n\n/**\n * Reason for isolating doPerformMultiAction from performMultiAction is for reusing performMultiAction\n * across android-drivers (like appium-uiautomator2-driver) and to avoid code duplication.\n * Other android-drivers (like appium-uiautomator2-driver) need to override doPerformMultiAction\n * to facilitate performMultiAction.\n */\ncommands.doPerformMultiAction = async function doPerformMultiAction (elementId, states) {\n  let opts;\n  if (elementId) {\n    opts = {\n      elementId,\n      actions: states\n    };\n    return await this.bootstrap.sendAction('element:performMultiPointerGesture', opts);\n  } else {\n    opts = {\n      actions: states\n    };\n    return await this.bootstrap.sendAction('performMultiPointerGesture', opts);\n  }\n};\n\nObject.assign(extensions, commands, helpers);\nexport { commands, helpers };\nexport default extensions;\n"],"mappings":"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"}