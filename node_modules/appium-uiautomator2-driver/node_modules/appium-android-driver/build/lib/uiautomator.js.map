{"version":3,"file":"uiautomator.js","names":["log","logger","getLogger","UiAutomator","events","EventEmitter","constructor","adb","errorAndThrow","tempPath","start","uiAutomatorBinaryPath","className","startDetector","extraParams","processIsAlive","debug","changeState","STATE_STARTING","jarName","parseJarNameFromPath","push","killUiAutomatorOnDevice","args","proc","createSubProcess","on","code","signal","state","STATE_STOPPED","STATE_STOPPING","msg","error","STATE_ONLINE","e","emit","EVENT_ERROR","stop","shutdown","binaryPath","reTest","exec","Error","EVENT_CHANGED","killProcessesByName","warn"],"sources":["../../lib/uiautomator.js"],"sourcesContent":["import events from 'events';\nimport { logger } from 'appium/support';\n\n\nconst log = logger.getLogger('UiAutomator');\n\nclass UiAutomator extends events.EventEmitter {\n  constructor (adb) {\n    if (!adb) {\n      log.errorAndThrow('adb is required to instantiate UiAutomator');\n    }\n    super();\n    this.adb = adb;\n    this.tempPath = '/data/local/tmp/';\n  }\n\n  async start (uiAutomatorBinaryPath, className, startDetector, ...extraParams) {\n    let processIsAlive;\n    try {\n      log.debug('Starting UiAutomator');\n      this.changeState(UiAutomator.STATE_STARTING);\n\n      log.debug('Parsing uiautomator jar');\n      // expecting a path like /ads/ads/foo.jar or \\asd\\asd\\foo.jar\n      let jarName = this.parseJarNameFromPath(uiAutomatorBinaryPath);\n      await this.adb.push(uiAutomatorBinaryPath, this.tempPath);\n\n      // killing any uiautomator existing processes\n      await this.killUiAutomatorOnDevice();\n\n      log.debug('Starting UIAutomator');\n      let args = ['shell', 'uiautomator', 'runtest', jarName, '-c', className, ...extraParams];\n      this.proc = this.adb.createSubProcess(args);\n\n      // handle out-of-bound exit by simply emitting a stopped state\n      this.proc.on('exit', (code, signal) => {\n        processIsAlive = false;\n        // cleanup\n        if (this.state !== UiAutomator.STATE_STOPPED &&\n            this.state !== UiAutomator.STATE_STOPPING) {\n          let msg = `UiAutomator exited unexpectedly with code ${code}, ` +\n                    `signal ${signal}`;\n          log.error(msg);\n        } else if (this.state === UiAutomator.STATE_STOPPING) {\n          log.debug('UiAutomator shut down normally');\n        }\n        this.changeState(UiAutomator.STATE_STOPPED);\n      });\n\n      await this.proc.start(startDetector);\n      processIsAlive = true;\n      this.changeState(UiAutomator.STATE_ONLINE);\n      return this.proc;\n    } catch (e) {\n      this.emit(UiAutomator.EVENT_ERROR, e);\n      if (processIsAlive) {\n        await this.killUiAutomatorOnDevice();\n        await this.proc.stop();\n      }\n      log.errorAndThrow(e);\n    }\n  }\n\n  async shutdown () {\n    log.debug('Shutting down UiAutomator');\n    if (this.state !== UiAutomator.STATE_STOPPED) {\n      this.changeState(UiAutomator.STATE_STOPPING);\n      await this.proc.stop();\n    }\n    await this.killUiAutomatorOnDevice();\n    this.changeState(UiAutomator.STATE_STOPPED);\n  }\n\n  parseJarNameFromPath (binaryPath) {\n    let reTest = /.*(\\/|\\\\)(.*\\.jar)/.exec(binaryPath);\n    if (!reTest) {\n      throw new Error(`Unable to parse jar name from ${binaryPath}`);\n    }\n    let jarName = reTest[2];\n    log.debug(`Found jar name: '${jarName}'`);\n    return jarName;\n  }\n\n  changeState (state) {\n    log.debug(`Moving to state '${state}'`);\n    this.state = state;\n    this.emit(UiAutomator.EVENT_CHANGED, {state});\n  }\n\n  async killUiAutomatorOnDevice () {\n    try {\n      await this.adb.killProcessesByName('uiautomator');\n    } catch (e) {\n      log.warn(`Error while killing uiAutomator: ${e}`);\n    }\n  }\n\n}\n\nUiAutomator.EVENT_ERROR = 'uiautomator_error';\nUiAutomator.EVENT_CHANGED = 'stateChanged';\nUiAutomator.STATE_STOPPING = 'stopping';\nUiAutomator.STATE_STOPPED = 'stopped';\nUiAutomator.STATE_STARTING = 'starting';\nUiAutomator.STATE_ONLINE = 'online';\n\n\nexport { UiAutomator };\nexport default UiAutomator;\n"],"mappings":"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"}